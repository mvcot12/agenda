<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda mensual · Mateo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

<style>
:root{
  --bg:#fafafa;   --card:#ffffff; --border:#e0e0e0; --txt:#333; --muted:#666;
  --accent:#2ecc71;--neutra:#b2bec3;--baja:#9b59b6;--media:#f1c40f;--alta:#e67e22;--urgente:#e74c3c;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Inter',Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);
  display:flex;flex-direction:column;align-items:center;padding:1.4rem;
}
h1{font-size:1.7rem;font-weight:600;margin-bottom:1rem;text-align:center}
.container{width:100%;max-width:900px}
/*--- buscador ---*/
#searchBox{display:flex;justify-content:center;margin-bottom:1.1rem}
#googleInput{
  flex:1;max-width:360px;background:var(--card);color:var(--txt);
  border:1px solid var(--border);border-radius:999px;padding:.48rem 1rem;font-size:.92rem;
}
#googleInput::placeholder{color:var(--muted)}
/*--- calendario ---*/
#calHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
.navBtn{background:none;border:none;font-size:1.4rem;color:var(--accent);cursor:pointer;font-weight:600}
#monthLabel{font-size:1.2rem;font-weight:600}
table{width:100%;border-collapse:collapse}
th,td{
  width:14.285%;height:95px;vertical-align:top;text-align:left;
  border:1px solid var(--border);background:var(--card);position:relative
}
th{background:#f0f0f0;height:35px;font-size:.8rem;font-weight:600;color:var(--muted)}
td span.dayNum{position:absolute;top:6px;left:6px;font-size:.8rem;font-weight:600}
.badge{position:absolute;top:4px;right:6px;background:var(--accent);color:#fff;border-radius:50%;font-size:.65rem;width:18px;height:18px;display:flex;align-items:center;justify-content:center}
td.today{outline:3px solid var(--accent)}
/*--- listas ---*/
#todayHeader{font-size:1.15rem;font-weight:600;margin:.9rem 0 .6rem}
.sectionTitle{font-size:.9rem;font-weight:600;margin:.6rem 0 .3rem;color:var(--muted)}
.task{
  display:flex;gap:.65rem;align-items:center;background:var(--card);
  border-left:6px solid var(--neutra);border-radius:8px;
  padding:.55rem .8rem;margin-bottom:.45rem;box-shadow:0 1px 3px rgba(0,0,0,.07)
}
[data-priority="Baja"]{border-color:var(--baja)}
[data-priority="Media"]{border-color:var(--media)}
[data-priority="Alta"]{border-color:var(--alta)}
[data-priority="Urgente"]{border-color:var(--urgente)}
.task.completed{opacity:.45;text-decoration:line-through}
.task span{flex:1;font-size:.9rem}
.task input{width:1.05rem;height:1.05rem;cursor:pointer}
.empty{opacity:.55;font-style:italic;padding:.5rem 0}
/*--- formulario ---*/
details{margin-top:1.3rem}
summary{cursor:pointer;font-weight:600;margin-bottom:.7rem}
form label{display:block;font-size:.83rem;margin:.35rem 0}
form input,form select{
  width:100%;padding:.42rem .5rem;font-size:.83rem;background:var(--card);color:var(--txt);
  border:1px solid var(--border);border-radius:6px;
}
form input::placeholder{color:var(--muted)}
button{border:none;background:var(--accent);color:#fff;font-weight:600;padding:.5rem 1.1rem;border-radius:6px;margin-top:.8rem;cursor:pointer}
button:hover{opacity:.9}
</style>
</head>
<body>
<h1>Agenda mensual · Mateo</h1>

<!-- buscador Google -->
<form id="searchBox" action="https://www.google.com/search">
  <input id="googleInput" name="q" type="search" placeholder="Buscar en Google…">
</form>

<div class="container">
  <div id="calHeader">
    <button class="navBtn" id="prev">&lt;</button>
    <div id="monthLabel"></div>
    <button class="navBtn" id="next">&gt;</button>
  </div>
  <table id="calendar"></table>

  <h2 id="todayHeader"></h2>
  <div id="tasks"></div>

  <details>
    <summary>➕ Añadir pendiente</summary>
    <form id="addForm">
      <label>Fecha
        <input type="date" id="taskDate" required>
      </label>
      <label>Descripción
        <input type="text" id="taskDesc" required placeholder="Ej. revisar inventario">
      </label>
      <label>Prioridad
        <select id="taskPriority">
          <option value="Neutra">Neutra</option>
          <option value="Baja">Baja</option>
          <option value="Media">Media</option>
          <option value="Alta">Alta</option>
        </select>
      </label>
      <label>Hora (opcional)
        <input type="time" id="taskTime">
      </label>
      <button type="submit">Guardar</button>
    </form>
  </details>
</div>

<script>
/*----------- Configuración Dropbox -----------*/
const DBX = new Dropbox.Dropbox({ accessToken:sl.u.AF1hgItuRPRXAsNonpBQqGtsbEjWXFvgQtaBemhJTx8CdOHBRluj2fjwgB-qdfBzEG5G5deiZNrRHuU2FVzJb9XFcEMCOMmea3AnyunMxMMiRP2Ky3JGKKb-g0qL8pspaHF7_XgJi6XEqgFZPbI2hQDHiWWOdvRqCbgx5Gfn30aiRi14d8wrxvTGTbxSUqizUfqpE7wFWYMuFiyTmWgFE6DgHOkrwbEaLi7TNWE3xfEl_rG9j5Zq5zMesqdpG7Aam-0ttm2C9zYIAzm2R8wBQ_MqcaUf56QTnMVWgOl5b8CDlCDfXM0OkLFhIfmPhBb5RDI_YXeXy4QM1JSfOI_uh233xpSO93CH6_VOZTD9Twq_Wrci32--0mMF1mTutratcJkFmb_AZXwtnEhOAnPHvKpRgxXVQzDe7l819NvhxBc-PHPfS2WMV9cpVNVc1D6QsEBHG7sIgHw8ybIZWIW464Dg29ET4JwvLCEx4GR1SNxsVdo9fCuUfvwHT5Wyefo0NqE6FusTb3KxwIP0BSKFIa60CdnMYjytGn_JrHsVkirLSrOI0XUim7vWWHCWgsLEKZXaqg4udUSk_JU3gMXrcEi2jrLAjiKS2uzZ5jdap4_sfY30fIqSXAj-RhWoZq466074qOm-mmEUASMUUiVF9IyaHihJscrER174GJDlX-qayXMnnnadMicTNI8BiJ8N0gW8TG8u00byRntB_NFG417Ez9en0Yb3nAvyK2o9jB0hTGQYB8VK-xVn0bDeqKnHQBhD8pWF8f_qfXleh_y5f8-iUPs4RBURWtAKP9FkIq1NZP3KoimSt6ouSq79xJtI3CdLzP7ihQfypstGayGxs0fby2GuUaTtmE4mzvNOIaUtEzDQQAvBARlWVXjb6SxUjFjqWRrBE2zDnSHGpgINczMBtW5JNdkh8Uk5hO75e1v0cSLVQsCSL-l271lncrvqz4mj1PJ99Uc9WfUz_vNmg65kKFlaeOnopWOOPkO7u8NF1IThsRC_fMzzT0a1yVIypPq-Kd2wUiUw9wvrTE3o0NIhKOKiMmQwZv6MhfEMi1KEclvfRadBAb8L4wI2BWtROGFpD5-0Dd2CN1fTKkm6DsZY5OTbKZJj8UV6yomDFfgDbUzd3k9vGX1AWmap6G5zVPzkDYvLoOsps6vtua9BvY6ayTIoAXQb-tU6fFs2gsYKcz3CEtKT5-GTRf4ngSAJbD71-HH-0vHOCqN98fVDa4NkGs8oNNeyoIWs1nE4klsvznuZrNCt7CXnu7RU_G_0LIYQ7Np8vAb2mMfyTx7GYP9Y });
const FILE="/tasks.json";

/*----------- Datos -----------*/
const levels=["Neutra","Baja","Media","Alta","Urgente"];
const escalate={Neutra:4,Baja:3,Media:2,Alta:1};
let tasks=[];
let viewDate=new Date();

/*----------- Utilidades -----------*/
const parseYMD=s=>{const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d)};
const sameDate=(a,b)=>a.toDateString()===b.toDateString();

/*----------- Arranque -----------*/
(async()=>{
  tasks = await loadFromDropbox();
  prev.onclick = ()=>{viewDate.setMonth(viewDate.getMonth()-1);drawCal()};
  next.onclick = ()=>{viewDate.setMonth(viewDate.getMonth()+1);drawCal()};
  addForm.addEventListener("submit",handleAdd);
  googleInput.focus();
  escalateLate();drawCal();drawList(new Date());
})();

/*----------- Dropbox I/O -----------*/
async function loadFromDropbox(){
  try{
    const resp=await DBX.filesDownload({path:FILE});
    return JSON.parse(await resp.result.fileBlob.text());
  }catch{return [];}
}
async function saveToDropbox(){
  await DBX.filesUpload({path:FILE,mode:{".tag":"overwrite"},contents:JSON.stringify(tasks)});
}

/*----------- Calendario -----------*/
function drawCal(){
  monthLabel.textContent=viewDate.toLocaleDateString("es-EC",{month:"long",year:"numeric"});
  const tbl=calendar;tbl.innerHTML="";
  const head=document.createElement("tr");
  ["lun","mar","mié","jue","vie","sáb","dom"].forEach(d=>{const th=document.createElement("th");th.textContent=d;head.appendChild(th);});
  tbl.appendChild(head);

  const y=viewDate.getFullYear(),m=viewDate.getMonth();
  const first=new Date(y,m,1);
  const offset=(first.getDay()+6)%7;
  const daysInMonth=new Date(y,m+1,0).getDate();
  let row=document.createElement("tr");
  for(let i=0;i<offset;i++)row.appendChild(document.createElement("td"));
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(y,m,d);
    const td=document.createElement("td");
    if(sameDate(date,new Date()))td.classList.add("today");
    td.innerHTML=`<span class="dayNum">${d}</span>`;
    const count=tasks.filter(t=>!t.done && sameDate(parseYMD(t.date),date)).length;
    if(count){
      const badge=document.createElement("div");
      badge.className="badge";badge.textContent=count;td.appendChild(badge);
    }
    td.onclick=()=>drawList(date);
    row.appendChild(td);
    if((offset+d)%7===0||d===daysInMonth){
      while(row.children.length<7)row.appendChild(document.createElement("td"));
      tbl.appendChild(row);row=document.createElement("tr");
    }
  }
}

/*----------- Lista diaria -----------*/
function drawList(date){
  todayHeader.textContent=date.toLocaleDateString("es-EC",{weekday:"long",day:"numeric",month:"long"});
  const list=document.getElementById("tasks");list.innerHTML="";
  const pend=tasks.filter(t=>!t.done && sameDate(parseYMD(t.date),date));
  const comp=tasks.filter(t=>t.done && sameDate(parseYMD(t.date),date));

  if(!pend.length && !comp.length){
    list.innerHTML='<div class="empty">Sin pendientes.</div>';return;
  }

  if(pend.length){
    pend.sort((a,b)=>levels.indexOf(b.priority)-levels.indexOf(a.priority));
    pend.forEach(t=>list.append( buildTask(t,date,false) ));
  }
  if(comp.length){
    list.insertAdjacentHTML("beforeend",'<div class="sectionTitle">Completados</div>');
    comp.sort((a,b)=>b.id-a.id);
    comp.forEach(t=>list.append( buildTask(t,date,true) ));
  }
}
function buildTask(t,focus,done){
  const div=document.createElement("div");
  div.className="task"+(done?" completed":"");div.dataset.priority=t.priority;
  const chk=document.createElement("input");chk.type="checkbox";chk.checked=done;
  chk.onchange=()=>toggleDone(t.id,focus);
  const span=document.createElement("span");
  span.textContent=`[${t.priority}] ${t.desc}${t.time?` – ${t.time}`:""}`;
  div.append(chk,span);
  return div;
}

/*----------- Toggle Done -----------*/
async function toggleDone(id,focusDate){
  const t=tasks.find(x=>x.id===id);
  if(!t)return;
  t.done=!t.done;
  drawCal();drawList(focusDate);   // UI inmediata
  await saveToDropbox();           // persiste
}

/*----------- Añadir tarea -----------*/
async function handleAdd(e){
  e.preventDefault();
  const {taskDate,taskDesc,taskPriority,taskTime}=e.target.elements;
  if(!taskDate.value || !taskDesc.value.trim())return;
  tasks.push({
    id:Date.now(),date:taskDate.value,desc:taskDesc.value.trim(),
    priority:taskPriority.value,time:taskTime.value,done:false
  });
  drawCal();drawList(parseYMD(taskDate.value)); // UI inmediata
  await saveToDropbox();                         // persiste
  escalateLate();   // corrige retrasadas
  e.target.reset();e.target.parentElement.open=false;
}

/*----------- Escalar retrasadas -----------*/
function escalateLate(){
  const now=new Date();
  tasks.forEach(t=>{
    if(t.done)return;
    const d=parseYMD(t.date);
    if(d<now){
      const diff=Math.floor((now-d)/86400000);
      t.date=now.toISOString().split("T")[0];
      const lim=escalate[t.priority];
      if(lim!==undefined && diff>=lim){
        const idx=levels.indexOf(t.priority);
        if(idx<levels.length-1)t.priority=levels[idx+1];
      }
    }
  });
}
</script>
</body>
</html>
