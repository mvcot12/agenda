<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda mensual Â· Mateo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://apis.google.com/js/api.js"></script>

<style>
:root{
  --bg:#fafafa;--card:#fff;--border:#ddd;--txt:#333;--muted:#666;
  --accent:#2ecc71;--neutra:#b2bec3;--baja:#9b59b6;--media:#f1c40f;
  --alta:#e67e22;--urgente:#e74c3c;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--txt);
     display:flex;flex-direction:column;align-items:center;padding:1rem}
h1{font-size:1.75rem;font-weight:600;margin-bottom:1rem;text-align:center}
.container{width:100%;max-width:900px}

/* â€”â€”â€” Buscador â€”â€”â€” */
#searchBox{display:flex;justify-content:center;margin-bottom:1rem}
#googleInput{flex:1;max-width:360px;background:var(--card);border:1px solid var(--border);
  border-radius:999px;padding:.5rem 1rem;font-size:.95rem;color:var(--txt)}
#googleInput::placeholder{color:var(--muted)}

/* â€”â€”â€” Calendario â€”â€”â€” */
#calHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
.nav{background:none;border:none;font-size:1.4rem;color:var(--accent);cursor:pointer;font-weight:600}
#monthLabel{font-size:1.2rem;font-weight:600}
table{width:100%;border-collapse:collapse}
th,td{width:14.285%;height:90px;border:1px solid var(--border);background:var(--card);
      vertical-align:top;position:relative}
th{background:#f0f0f0;height:35px;font-size:.8rem;font-weight:600;color:var(--muted)}
td span.day{position:absolute;top:6px;left:6px;font-size:.8rem;font-weight:600}
.badge{position:absolute;top:4px;right:6px;background:var(--accent);color:#fff;border-radius:50%;
       font-size:.65rem;width:18px;height:18px;display:flex;align-items:center;justify-content:center}
.today{outline:3px solid var(--accent)}

/* â€”â€”â€” Lista diaria â€”â€”â€” */
#todayHeader{font-size:1.15rem;font-weight:600;margin:.9rem 0 .6rem}
.section{font-size:.9rem;font-weight:600;margin:.6rem 0 .3rem;color:var(--muted)}
.task{display:flex;align-items:center;gap:.7rem;background:var(--card);border-left:6px solid var(--neutra);
      border-radius:8px;padding:.6rem .8rem;margin-bottom:.5rem;box-shadow:0 1px 3px rgba(0,0,0,.07)}
[data-p="Baja"]{border-color:var(--baja)}
[data-p="Media"]{border-color:var(--media)}
[data-p="Alta"]{border-color:var(--alta)}
[data-p="Urgente"]{border-color:var(--urgente)}
.task.completed{opacity:.45;text-decoration:line-through}
.task span{flex:1;font-size:.9rem}
.task input{width:1.05rem;height:1.05rem;cursor:pointer}
.empty{opacity:.5;font-style:italic;padding:.5rem 0}

/* â€”â€”â€” Formulario â€”â€”â€” */
details{margin-top:1.2rem}
summary{cursor:pointer;font-weight:600;margin-bottom:.7rem}
form label{display:block;font-size:.83rem;margin:.35rem 0}
form input,form select{width:100%;padding:.4rem .5rem;font-size:.83rem;
  background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--txt)}
button{border:none;background:var(--accent);color:#fff;font-weight:600;
  padding:.5rem 1.2rem;border-radius:6px;margin-top:.8rem;cursor:pointer}
button:hover{opacity:.9}
</style>
</head>

<body>
<h1>Agenda mensual Â· Mateo</h1>

<form id="searchBox" action="https://www.google.com/search">
  <input id="googleInput" name="q" type="search" placeholder="Buscar en Googleâ€¦">
</form>

<div class="container">
  <div id="calHeader">
    <button class="nav" id="prev">&#x276E;</button>
    <div id="monthLabel"></div>
    <button class="nav" id="next">&#x276F;</button>
  </div>
  <table id="calendar"></table>

  <h2 id="todayHeader"></h2>
  <div id="tasks"></div>

  <details>
    <summary>âž• AÃ±adir pendiente</summary>
    <form id="addForm">
      <label>Fecha <input type="date" id="fDate" required></label>
      <label>DescripciÃ³n <input type="text" id="fDesc" required></label>
      <label>Prioridad
        <select id="fPrio">
          <option>Neutra</option><option>Baja</option><option>Media</option><option>Alta</option>
        </select>
      </label>
      <label>Hora (opcional) <input type="time" id="fTime"></label>
      <button>Guardar</button>
    </form>
  </details>
</div>

<script>
/* â€”â€”â€” CONFIGURACIÃ“N GOOGLE â€”â€”â€” */
const CLIENT_ID = "757607272032-1gd3rehhb3h36ois2lefc3osfolshrvj.apps.googleusercontent.com";
const SCOPES    = "https://www.googleapis.com/auth/drive.appdata";
const FILE_NAME = "tasks.json";

/* â€”â€”â€” Pedir API Key al usuario la primera vez â€”â€”â€” */
let API_KEY = localStorage.getItem("agendaApiKey");
if(!API_KEY){
  API_KEY = prompt("ðŸ”‘ Introduce tu Google API Key:");
  if(!API_KEY) {
    alert("Se necesita la API Key para continuar.");
    throw new Error("Sin API Key");
  }
  localStorage.setItem("agendaApiKey", API_KEY);
}

/* â€”â€”â€” Helpers y datos â€”â€”â€” */
const $ = id=>document.getElementById(id);
const iso = d=>d.toISOString().slice(0,10);
const parse = s=>new Date(s+"T00:00");
const same=(a,b)=>iso(a)===iso(b);

let tasks=[], viewDate=new Date();
const LEVELS=["Neutra","Baja","Media","Alta","Urgente"];
const ESC={Neutra:4,Baja:3,Media:2,Alta:1};

/* â€”â€”â€” Iniciar gapi â€”â€”â€” */
gapi.load("client:auth2",()=>{
  gapi.client.init({
    apiKey:API_KEY, clientId:CLIENT_ID, scope:SCOPES,
    discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
  }).then(()=>const auth = gapi.auth2.getAuthInstance();
auth.signIn({
  ux_mode: "redirect",
  redirect_uri: window.location.href
});
// _No_ llames a initAgenda() aquÃ­: la pÃ¡gina se recargarÃ¡ tras aprobar permisos.
async function initAgenda() {
  // Si llegamos aquÃ­ por redirect, gapi ya ha almacenado el token automÃ¡ticamente.
  // Simplemente continuamos con la carga normal:
  tasks = await loadTasks();
  /* â€¦ resto de tu initAgenda â€¦ */
}

    .then(initAgenda)
    .catch(e=>alert("Google Auth error: "+e.error));
});

/* â€”â€”â€” Drive I/O â€”â€”â€” */
async function fileId(){
  const r=await gapi.client.drive.files.list({spaces:"appDataFolder",q:`name='${FILE_NAME}' and trashed=false`});
  return r.result.files[0]?.id||null;
}
async function loadTasks(){
  const id=await fileId();
  if(!id) return [];
  const r=await gapi.client.drive.files.get({fileId:id,alt:"media"});
  return JSON.parse(r.body||"[]");
}
async function saveTasks(){
  const id=await fileId();
  const meta={name:FILE_NAME,parents:["appDataFolder"]};
  const blob=new Blob([JSON.stringify(tasks)],{type:"application/json"});
  if(id){
    await gapi.client.drive.files.update({fileId:id,uploadType:"multipart",resource:meta,media:{body:blob}});
  }else{
    await gapi.client.drive.files.create({uploadType:"multipart",resource:meta,media:{body:blob}});
  }
}

/* â€”â€”â€” Calendario y lista â€”â€”â€” */
function buildCal(){ /* (igual que antes) */ /* ... */ }
function renderList(d){ /* ... */ }
function taskEl(t,done,d){ /* ... */ }

/* â€”â€”â€” LÃ³gica â€”â€”â€” */
function escalate(){ /* ... mismo algoritmo ... */ }
function toggleDone(id,d){ const t=tasks.find(x=>x.id===id); if(!t)return;
  t.done=!t.done; saveTasks().then(()=>{buildCal();renderList(d);}); }
function addTask(e){ e.preventDefault();
  if(!fDate.value||!fDesc.value.trim())return;
  tasks.push({id:Date.now(),date:fDate.value,desc:fDesc.value.trim(),
              priority:fPrio.value,time:fTime.value,done:false});
  escalate(); saveTasks().then(()=>{
    buildCal();renderList(parse(fDate.value));
    e.target.reset(); e.target.parentElement.open=false;
  });
}

/* â€”â€”â€” Inicio Agenda â€”â€”â€” */
async function initAgenda(){
  tasks=await loadTasks(); escalate(); await saveTasks();
  buildCal(); renderList(new Date());
  $("prev").onclick=()=>{viewDate.setMonth(viewDate.getMonth()-1);buildCal();};
  $("next").onclick=()=>{viewDate.setMonth(viewDate.getMonth()+1);buildCal();};
  $("addForm").addEventListener("submit",addTask);
  $("googleInput").focus();
}
</script>
</body>
</html>
